<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥½é£Ÿæ©Ÿ HaoShiJi | é£Ÿå®‰æŠŠé—œé¦–é¸</title>
    <link rel="icon" href="https://hao-shi-ji.vercel.app/static/favicon.ico" type="image/x-icon">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Old+Mincho:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-sage: #84A98C; /* é¼ å°¾è‰ç¶  */
            --primary-dark: #354F52; /* æ·±æ£®æ—ç¶  */
            --accent-tan: #b8c8ae;   /* æ·ºäºéº»ç¶  */
            --bg-cream: #F8F9F7;     /* æ¥µç°¡å¥¶æ²¹ç™½ */
            --text-main: #2F3E46;    /* ç‚­ç°è‰² */
            --text-muted: #667771;   /* ç°ç¶ è‰² */
            --card-bg: #FFFFFF;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* é—œéµå­—å°ˆç”¨è‰²å€¼ */
            --kw-green-bg: rgba(132, 169, 140, 0.12);
            --kw-green-text: #4A6D55;
            --kw-red-bg: rgba(214, 40, 40, 0.08);
            --kw-red-text: #D62828;
        }

        body {
            background-color: var(--bg-cream);
            color: var(--text-main);
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 15px;
            letter-spacing: 0.02em;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            margin: 0;
        }

        /* Header Section */
        .header-section {
            background-color: var(--card-bg);
            padding: 50px 20px 40px;
            text-align: center;
            border-bottom: 1px solid var(--accent-tan);
            background-image: radial-gradient(var(--bg-cream) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .brand-title {
            font-family: 'Zen Old Mincho', serif;
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin: 0;
            letter-spacing: 8px;
        }

        .brand-subtitle {
            font-size: 1.1rem;
            color: var(--primary-sage);
            margin: 5px 0 15px;
            font-weight: 400;
            letter-spacing: 5px;
            text-transform: uppercase;
        }

        .brand-tagline {
            display: inline-block;
            font-size: 0.95rem;
            color: var(--text-muted);
            margin-top: 5px;
            position: relative;
            padding: 0 30px;
        }
        
        .brand-tagline::before, .brand-tagline::after {
            content: "";
            position: absolute;
            top: 50%;
            width: 20px;
            height: 1px;
            background-color: var(--accent-tan);
        }
        .brand-tagline::before { left: 0; }
        .brand-tagline::after { right: 0; }

        /* Search Section */
        .search-section {
            background-color: var(--card-bg);
            padding: 30px;
            margin: -25px auto 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(53, 79, 82, 0.05);
            border: 1px solid var(--accent-tan);
            max-width: 1100px;
            width: 100%;
            position: relative;
            z-index: 10;
        }
        
        /* Main Content Section - èˆ‡æœå°‹å€å¡ŠåŒå¯¬ */
        .main-content {
            max-width: 1100px;
            width: 100%;
            padding: 0 15px;
        }

        .search-section h4 {
            font-family: 'Zen Old Mincho', serif;
            color: var(--primary-dark);
            font-weight: 700;
            font-size: 1.4rem;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .form-control, .form-select {
            background-color: var(--bg-cream);
            border: 1px solid var(--accent-tan);
            color: var(--text-main);
            border-radius: 12px;
            padding: 10px 15px;
            transition: var(--transition);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-sage);
            box-shadow: 0 0 0 4px rgba(132, 169, 140, 0.15);
            background-color: #fff;
        }

        .form-label {
            color: var(--primary-dark);
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        #searchBtn {
            background-color: var(--primary-dark);
            color: #fff;
            padding: 10px 30px;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            transition: var(--transition);
        }

        #searchBtn:hover {
            background-color: var(--primary-sage);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(132, 169, 140, 0.3);
        }

        /* Content Section */
        .content-section {
            display: flex;
            gap: 25px;
            height: 650px;
            margin-bottom: 40px;
        }

        .map-container {
            flex: 1.4;
            background-color: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.03);
            overflow: hidden;
            border: 1px solid var(--accent-tan);
        }

        .restaurant-list-container {
            flex: 1;
            background-color: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.03);
            overflow: hidden;
            border: 1px solid var(--accent-tan);
            display: flex;
            flex-direction: column;
        }

        .restaurant-list-header {
            background-color: #fff;
            border-bottom: 1px solid var(--bg-cream);
            padding: 20px 25px;
            z-index: 10;
        }

        .restaurant-list-header h5 {
            font-family: 'Zen Old Mincho', serif;
            color: var(--primary-dark);
            font-weight: 700;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #restaurantListDiv {
            overflow-y: auto;
            flex-grow: 1;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-tan) transparent;
        }

        /* Restaurant Card Style */
        .restaurant-card {
            border: none;
            border-bottom: 1px solid var(--bg-cream);
            background-color: transparent;
            transition: var(--transition);
            padding: 20px 25px;
            display: block;
            text-decoration: none;
            cursor: pointer;
            position: relative;
        }

        .restaurant-card:hover {
            background-color: var(--bg-cream);
        }

        /* é«˜äº®é¡¯ç¤ºé¸ä¸­çš„é¤å»³å¡ç‰‡ */
        .restaurant-card.active {
            background-color: #E8F3ED;
            border-left: 4px solid var(--primary-sage);
            padding-left: 21px;
        }

        .restaurant-card.active::before {
            content: "\f3c5";
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
            color: var(--primary-sage);
            animation: bounce 0.5s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(-50%); }
            50% { transform: translateY(-60%); }
        }

        .card-title {
            color: var(--primary-dark);
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .star-rating {
            color: #E9C46A;
            font-size: 0.9rem;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .address-text {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .food-safety-badge {
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        /* é¢¨éšªç­‰ç´šæ¨£å¼ */
        .badge-certified { background-color: #E8F3ED; color: #2D5016; border: 1px solid rgba(45, 80, 22, 0.2); font-weight: 700; }
        .badge-safe { background-color: #F0F9FF; color: #0369A1; border: 1px solid rgba(3, 105, 161, 0.15); }
        .badge-low-risk { background-color: #FFFBEB; color: #B45309; border: 1px solid rgba(180, 83, 9, 0.2); }
        .badge-medium-risk { background-color: #FFFBEB; color: #B45309; border: 1px solid rgba(180, 83, 9, 0.2); }
        .badge-high-risk { background-color: #FEF2F2; color: #991B1B; border: 1px solid rgba(153, 27, 27, 0.2); font-weight: 700; }
        .badge-inspection-failed { background-color: #FEE2E2; color: #7F1D1D; border: 2px solid #991B1B; font-weight: 700; }
        
        /* ä¿ç•™å‘ä¸‹ç›¸å®¹ */
        .badge-excellent { background-color: #E8F3ED; color: #4F772D; border: 1px solid rgba(79, 119, 45, 0.1); }
        .badge-good { background-color: #F1F5F9; color: #475569; border: 1px solid rgba(71, 85, 105, 0.1); }
        .badge-normal { background-color: #FFFBEB; color: #B45309; border: 1px solid rgba(180, 83, 9, 0.1); }
        .badge-risk { background-color: #FEF2F2; color: #991B1B; border: 1px solid rgba(153, 27, 27, 0.1); }
        .badge-official { background-color: var(--primary-sage); color: #fff; font-size: 0.65rem; }

        .keyword-tag {
            background-color: var(--kw-green-bg);
            color: var(--kw-green-text);
            padding: 4px 14px;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid transparent;
            margin-right: 8px;
            margin-top: 10px;
            display: inline-block;
            transition: var(--transition);
            position: relative;
        }

        .keyword-tag:hover {
            transform: scale(1.05);
            background-color: var(--primary-sage);
            color: #ffffff;
            box-shadow: 0 4px 8px rgba(132, 169, 140, 0.2);
        }

        .keyword-tag.risk {
            background-color: var(--kw-red-bg);
            color: var(--kw-red-text);
            font-weight: 600;
            border: 1px solid rgba(214, 40, 40, 0.15);
        }

        .keyword-tag.risk:hover {
            background-color: var(--kw-red-text);
            color: #ffffff;
            box-shadow: 0 4px 8px rgba(214, 40, 40, 0.2);
        }

        .analysis-info {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 8px;
            opacity: 0.8;
            font-style: italic;
        }

        footer {
            padding: 30px;
            color: var(--text-muted);
            text-align: center;
            font-size: 0.85rem;
            border-top: 1px solid var(--accent-tan);
            background-color: #fff;
            margin-top: auto;
        }

        @media (max-width: 768px) {
            .content-section { height: auto; flex-direction: column; }
            .map-container { min-height: 350px; }
            .brand-title { font-size: 2.5rem; }
            .search-section { 
                padding: 20px;
            }
            .main-content {
                padding: 0 20px;
            }
        }
    </style>
</head>
<body>
    <div class="header-section">
        <h1 class="brand-title">å¥½é£Ÿæ©Ÿ</h1>
        <p class="brand-subtitle">Hao Shi Ji</p>
        <p class="brand-tagline">çœ‹å¥½æ¯ä¸€å£é£Ÿå®‰ï¼Œè®“ç›¸èšæ›´æ”¾å¿ƒã€‚</p>
    </div>

    <div class="container main-content">
        <!-- Search Section -->
        <div class="search-section">
            <h4><i class="fas fa-leaf" style="color: var(--primary-sage);"></i> å°‹æ‰¾å®‰å¿ƒé£Ÿæ‰€</h4>
            <!-- è³‡æ–™ç¯„åœæç¤º -->
            <div class="alert alert-info" role="alert" style="margin-bottom: 20px; font-size: 0.9rem; padding: 10px 15px; background-color: rgba(132, 169, 140, 0.1); border: 1px solid var(--primary-sage); color: var(--primary-dark); border-radius: 8px;">
                <i class="fas fa-info-circle"></i> 
                <strong>è³‡æ–™ç¯„åœèªªæ˜ï¼š</strong>ç›®å‰ç³»çµ±åƒ…æ”¶éŒ„å°åŒ—å¸‚çš„å®˜æ–¹èªè­‰é¤å»³åŠç¨½æ ¸ç´€éŒ„ï¼Œå…¶ä»–ç¸£å¸‚çš„æœå°‹çµæœå°‡ä¸åŒ…å«å®˜æ–¹è³‡æ–™ã€‚
            </div>
            <div class="row g-3 align-items-end">
                <div class="col-md-2">
                    <label for="citySelect" class="form-label">é¸æ“‡åŸå¸‚</label>
                    <select class="form-select" id="citySelect">
                        <option value="">è«‹é¸æ“‡ç¸£å¸‚</option>
                        <option value="taipei">å°åŒ—å¸‚</option>
                        <option value="new_taipei">æ–°åŒ—å¸‚</option>
                        <option value="taichung">å°ä¸­å¸‚</option>
                        <option value="tainan">å°å—å¸‚</option>
                        <option value="kaohsiung">é«˜é›„å¸‚</option>
                        <option value="keelung">åŸºéš†å¸‚</option>
                        <option value="taoyuan">æ¡ƒåœ’å¸‚</option>
                        <option value="hsinchu_city">æ–°ç«¹å¸‚</option>
                        <option value="hsinchu_county">æ–°ç«¹ç¸£</option>
                        <option value="miaoli">è‹—æ —ç¸£</option>
                        <option value="changhua">å½°åŒ–ç¸£</option>
                        <option value="nantou">å—æŠ•ç¸£</option>
                        <option value="yunlin">é›²æ—ç¸£</option>
                        <option value="chiayi_city">å˜‰ç¾©å¸‚</option>
                        <option value="chiayi_county">å˜‰ç¾©ç¸£</option>
                        <option value="pingtung">å±æ±ç¸£</option>
                        <option value="yilan">å®œè˜­ç¸£</option>
                        <option value="hualien">èŠ±è“®ç¸£</option>
                        <option value="taitung">å°æ±ç¸£</option>
                        <option value="penghu">æ¾æ¹–ç¸£</option>
                        <option value="kinmen">é‡‘é–€ç¸£</option>
                        <option value="lienchiang">é€£æ±Ÿç¸£</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="districtSelect" class="form-label">å€åŸŸç¯„åœ</label>
                    <select class="form-select" id="districtSelect" disabled>
                        <option value="">è«‹å…ˆé¸æ“‡åŸå¸‚</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="addressInput" class="form-label">é—œéµå­— / åœ°å€</label>
                    <input type="text" class="form-control" id="addressInput" placeholder="è¼¸å…¥å··å¼„æˆ–é¤å»³å">
                </div>
                <div class="col-md-2">
                    <button class="btn" id="searchBtn" style="width: 100%;">é–‹å§‹æ¢ç´¢</button>
                </div>
            </div>
        </div>

        <!-- Content Section -->
        <div class="content-section">
            <div class="map-container">
                <div id="mapDiv" style="width: 100%; height: 100%;"></div>
            </div>

            <div class="restaurant-list-container">
                <div class="restaurant-list-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-utensils" style="color: var(--primary-sage);"></i> åˆ†æçµæœ</h5>
                        <span class="badge rounded-pill bg-light text-dark border">
                            ç™¼ç¾ <span id="restaurantCount">0</span> è™•
                        </span>
                    </div>
                </div>
                
                <div id="restaurantListDiv">
                    <!-- å‡è³‡æ–™ç¯„ä¾‹ -->
                    
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p class="mb-0">&copy; 2026 å¥½é£Ÿæ©Ÿè£½ä½œåœ˜éšŠ</p>
        <p>è³‡æ–™ä¾†æºï¼šGoogle Maps åŠå„å¤§æ”¿åºœç¶²ç«™</p>
        <p class="mt-2">
            <a href="#" data-bs-toggle="modal" data-bs-target="#disclaimerModal" style="color: var(--primary-sage); text-decoration: none;">
                <i class="fas fa-exclamation-triangle"></i> å…è²¬è²æ˜
            </a>
        </p>
    </footer>

    <!-- å…è²¬è²æ˜ Modal -->
    <div class="modal fade" id="disclaimerModal" tabindex="-1" aria-labelledby="disclaimerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 15px; border: 1px solid var(--accent-tan);">
                <div class="modal-header" style="background-color: var(--bg-cream); border-bottom: 1px solid var(--accent-tan);">
                    <h5 class="modal-title" id="disclaimerModalLabel" style="color: var(--primary-dark); font-weight: 600;">
                        <i class="fas fa-info-circle" style="color: var(--primary-sage);"></i> å…è²¬è²æ˜
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="padding: 25px; color: var(--text-main); line-height: 1.8;">
                    <h6 style="color: var(--primary-dark); font-weight: 600; margin-bottom: 15px;">é—œæ–¼æœ¬å°ˆæ¡ˆ</h6>
                    <p>ã€Œå¥½é£Ÿæ©Ÿ HaoShiJiã€æ˜¯ä¸€å€‹<strong>ç¨‹å¼ç·´ç¿’å°ˆæ¡ˆ</strong>ï¼Œåƒ…ä¾›å­¸ç¿’å’ŒæŠ€è¡“å±•ç¤ºä¹‹ç”¨é€”ã€‚</p>
                    
                    <h6 style="color: var(--primary-dark); font-weight: 600; margin-top: 20px; margin-bottom: 15px;">ä½¿ç”¨é™åˆ¶</h6>
                    <ul style="padding-left: 20px;">
                        <li>æœ¬ç³»çµ±<strong>ä¸åšä»»ä½•å•†æ¥­è¡Œç‚º</strong></li>
                        <li>æœ¬ç³»çµ±<strong>ä¸é–‹æ”¾å¯¦éš›ä½¿ç”¨</strong></li>
                        <li>æ‰€æœ‰è³‡æ–™èˆ‡åˆ†æçµæœåƒ…ä¾›åƒè€ƒï¼Œè«‹å‹¿ä½œç‚ºå”¯ä¸€æ±ºç­–ä¾æ“š</li>
                        <li>æœ¬ç³»çµ±ä¸å°è³‡æ–™æº–ç¢ºæ€§ã€å³æ™‚æ€§æˆ–å®Œæ•´æ€§è² ä»»ä½•è²¬ä»»</li>
                    </ul>
                    
                    <h6 style="color: var(--primary-dark); font-weight: 600; margin-top: 20px; margin-bottom: 15px;">è³‡æ–™èªªæ˜</h6>
                    <p>æœ¬ç³»çµ±æ•´åˆå…¬é–‹è³‡æ–™åŠç¬¬ä¸‰æ–¹ APIï¼ˆå¦‚ Google Mapsï¼‰ï¼Œè³‡æ–™æ›´æ–°æ™‚é–“èˆ‡æ­£ç¢ºæ€§å¯èƒ½æœ‰æ‰€å·®ç•°ã€‚å¦‚éœ€å®˜æ–¹æœ€æ–°è³‡è¨Šï¼Œè«‹æ´½è©¢ç›¸é—œæ”¿åºœæ©Ÿæ§‹æˆ–é¤å»³æ¥­è€…ã€‚</p>
                    
                    <p class="mt-3 mb-0" style="color: var(--text-muted); font-size: 0.9rem;">
                        <i class="fas fa-calendar-alt"></i> æœ€å¾Œæ›´æ–°ï¼š2026 å¹´ 1 æœˆ
                    </p>
                </div>
                <div class="modal-footer" style="background-color: var(--bg-cream); border-top: 1px solid var(--accent-tan);">
                    <button type="button" class="btn btn-sm" data-bs-dismiss="modal" style="background-color: var(--primary-sage); color: white; padding: 8px 20px; border-radius: 8px;">
                        æˆ‘å·²äº†è§£
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // åŸå¸‚èˆ‡è¡Œæ”¿å€å°æ‡‰è¡¨
        const districts = {
            taipei: ['ä¸­æ­£å€', 'å¤§åŒå€', 'ä¸­å±±å€', 'æ¾å±±å€', 'å¤§å®‰å€', 'æ–‡å±±å€', 'å—æ¸¯å€', 'ä¿¡ç¾©å€', 'å£«æ—å€', 'åŒ—æŠ•å€', 'å…§æ¹–å€', 'è¬è¯å€'],
            new_taipei: ['æ¿æ©‹å€', 'æ±æ­¢å€', 'æ–°åº—å€', 'æ–°èŠå€', 'è˜†æ´²å€', 'ä¸‰é‡å€', 'ä¸­å’Œå€', 'æ°¸å’Œå€', 'åœŸåŸå€', 'æ¨¹æ—å€', 'æ·¡æ°´å€', 'ä¸‰å³½å€', 'é¶¯æ­Œå€', 'äº”è‚¡å€', 'æ³°å±±å€', 'æ—å£å€', 'æ·±å‘å€', 'çŸ³ç¢‡å€', 'åªæ—å€', 'ä¸‰èŠå€', 'çŸ³é–€å€', 'é‡‘å±±å€', 'è¬é‡Œå€', 'å¹³æºªå€', 'é›™æºªå€', 'è²¢å¯®å€', 'ç‘èŠ³å€', 'çƒä¾†å€'],
            keelung: ['ä»æ„›å€', 'ä¿¡ç¾©å€', 'ä¸­æ­£å€', 'ä¸­å±±å€', 'å®‰æ¨‚å€', 'æš–æš–å€', 'ä¸ƒå µå€'],
            taoyuan: ['æ¡ƒåœ’å€', 'ä¸­å£¢å€', 'å¹³é®å€', 'å…«å¾·å€', 'æ¥Šæ¢…å€', 'è˜†ç«¹å€', 'å¤§æºªå€', 'é¾æ½­å€', 'é¾œå±±å€', 'å¤§åœ’å€', 'è§€éŸ³å€', 'æ–°å±‹å€', 'å¾©èˆˆå€'],
            hsinchu_city: ['æ±å€', 'åŒ—å€', 'é¦™å±±å€'],
            hsinchu_county: ['ç«¹åŒ—å¸‚', 'ç«¹æ±é®', 'æ–°åŸ”é®', 'é—œè¥¿é®', 'æ¹–å£é„‰', 'æ–°è±é„‰', 'èŠæ—é„‰', 'æ©«å±±é„‰', 'åŒ—åŸ”é„‰', 'å¯¶å±±é„‰', 'å³¨çœ‰é„‰', 'å°–çŸ³é„‰', 'äº”å³°é„‰'],
            miaoli: ['è‹—æ —å¸‚', 'é ­ä»½å¸‚', 'ç«¹å—é®', 'å¾Œé¾é®', 'é€šéœ„é®', 'è‹‘è£¡é®', 'å“è˜­é®', 'é€ æ©‹é„‰', 'è¥¿æ¹–é„‰', 'é ­å±‹é„‰', 'å…¬é¤¨é„‰', 'éŠ…é‘¼é„‰', 'ä¸‰ç¾©é„‰', 'å¤§æ¹–é„‰', 'ç…æ½­é„‰', 'ä¸‰ç£é„‰', 'å—åº„é„‰', 'æ³°å®‰é„‰'],
            taichung: ['ä¸­å€', 'æ±å€', 'å—å€', 'è¥¿å€', 'åŒ—å€', 'åŒ—å±¯å€', 'è¥¿å±¯å€', 'å—å±¯å€', 'å¤ªå¹³å€', 'å¤§é‡Œå€', 'éœ§å³°å€', 'çƒæ—¥å€', 'è±åŸå€', 'åé‡Œå€', 'çŸ³å²¡å€', 'æ±å‹¢å€', 'å’Œå¹³å€', 'æ–°ç¤¾å€', 'æ½­å­å€', 'å¤§é›…å€', 'ç¥å²¡å€', 'å¤§è‚šå€', 'æ²™é¹¿å€', 'é¾äº•å€', 'æ¢§æ£²å€', 'æ¸…æ°´å€', 'å¤§ç”²å€', 'å¤–åŸ”å€', 'å¤§å®‰å€'],
            changhua: ['å½°åŒ–å¸‚', 'å“¡æ—å¸‚', 'å’Œç¾é®', 'é¹¿æ¸¯é®', 'æºªæ¹–é®', 'äºŒæ—é®', 'ç”°ä¸­é®', 'åŒ—æ–—é®', 'èŠ±å£‡é„‰', 'èŠ¬åœ’é„‰', 'å¤§æ‘é„‰', 'æ°¸é–é„‰', 'ä¼¸æ¸¯é„‰', 'ç·šè¥¿é„‰', 'ç¦èˆˆé„‰', 'ç§€æ°´é„‰', 'åŸ”å¿ƒé„‰', 'åŸ”é¹½é„‰', 'å¤§åŸé„‰', 'èŠ³è‹‘é„‰', 'ç«¹å¡˜é„‰', 'æºªå·é„‰', 'ç”°å°¾é„‰', 'ç¤¾é ­é„‰'],
            nantou: ['å—æŠ•å¸‚', 'åŸ”é‡Œé®', 'è‰å±¯é®', 'ç«¹å±±é®', 'é›†é›†é®', 'åé–“é„‰', 'é¹¿è°·é„‰', 'ä¸­å¯®é„‰', 'é­šæ± é„‰', 'åœ‹å§“é„‰', 'æ°´é‡Œé„‰', 'ä¿¡ç¾©é„‰', 'ä»æ„›é„‰'],
            yunlin: ['æ–—å…­å¸‚', 'æ–—å—é®', 'è™å°¾é®', 'è¥¿èºé®', 'åœŸåº«é®', 'åŒ—æ¸¯é®', 'å¤å‘é„‰', 'å¤§åŸ¤é„‰', 'è¿æ¡é„‰', 'æ—å…§é„‰', 'äºŒå´™é„‰', 'å´™èƒŒé„‰', 'éº¥å¯®é„‰', 'æ±å‹¢é„‰', 'è¤’å¿ é„‰', 'è‡ºè¥¿é„‰', 'å…ƒé•·é„‰', 'å››æ¹–é„‰', 'å£æ¹–é„‰', 'æ°´æ—é„‰'],
            chiayi_city: ['æ±å€', 'è¥¿å€'],
            chiayi_county: ['å¤ªä¿å¸‚', 'æœ´å­å¸‚', 'å¸ƒè¢‹é®', 'å¤§æ—é®', 'æ°‘é›„é„‰', 'æºªå£é„‰', 'æ–°æ¸¯é„‰', 'å…­è…³é„‰', 'æ±çŸ³é„‰', 'ç¾©ç«¹é„‰', 'é¹¿è‰é„‰', 'æ°´ä¸Šé„‰', 'ä¸­åŸ”é„‰', 'ç«¹å´é„‰', 'æ¢…å±±é„‰', 'ç•ªè·¯é„‰', 'å¤§åŸ”é„‰', 'é˜¿é‡Œå±±é„‰'],
            tainan: ['ä¸­è¥¿å€', 'æ±å€', 'å—å€', 'åŒ—å€', 'å®‰å¹³å€', 'å®‰å—å€', 'æ°¸åº·å€', 'æ­¸ä»å€', 'æ–°åŒ–å€', 'å·¦é®å€', 'ç‰äº•å€', 'æ¥ è¥¿å€', 'å—åŒ–å€', 'ä»å¾·å€', 'é—œå»Ÿå€', 'é¾å´å€', 'å®˜ç”°å€', 'éº»è±†å€', 'ä½³é‡Œå€', 'è¥¿æ¸¯å€', 'ä¸ƒè‚¡å€', 'å­¸ç”²å€', 'åŒ—é–€å€', 'æ–°ç‡Ÿå€', 'å¾Œå£å€', 'ç™½æ²³å€', 'æ±å±±å€', 'å…­ç”²å€', 'ä¸‹ç‡Ÿå€', 'æŸ³ç‡Ÿå€', 'é¹½æ°´å€', 'å–„åŒ–å€', 'å¤§å…§å€', 'å±±ä¸Šå€', 'æ–°å¸‚å€', 'å®‰å®šå€'],
            kaohsiung: ['æ–°èˆˆå€', 'å‰é‡‘å€', 'è‹“é›…å€', 'é¹½åŸ•å€', 'é¼“å±±å€', 'æ——æ´¥å€', 'å‰é®å€', 'ä¸‰æ°‘å€', 'æ¥ æ¢“å€', 'å°æ¸¯å€', 'å·¦ç‡Ÿå€', 'ä»æ­¦å€', 'å¤§ç¤¾å€', 'å²¡å±±å€', 'è·¯ç«¹å€', 'é˜¿è“®å€', 'ç”°å¯®å€', 'ç‡•å·¢å€', 'æ©‹é ­å€', 'æ¢“å®˜å€', 'å½Œé™€å€', 'æ°¸å®‰å€', 'æ¹–å…§å€', 'é³³å±±å€', 'å¤§å¯®å€', 'æ—åœ’å€', 'é³¥æ¾å€', 'å¤§æ¨¹å€', 'æ——å±±å€', 'ç¾æ¿ƒå€', 'å…­é¾œå€', 'å…§é–€å€', 'æ‰æ—å€', 'ç”²ä»™å€', 'æ¡ƒæºå€', 'é‚£ç‘ªå¤å€', 'èŒ‚æ—å€', 'èŒ„è£å€'],
            pingtung: ['å±æ±å¸‚', 'æ½®å·é®', 'æ±æ¸¯é®', 'æ†æ˜¥é®', 'è¬ä¸¹é„‰', 'é•·æ²»é„‰', 'éºŸæ´›é„‰', 'ä¹å¦‚é„‰', 'é‡Œæ¸¯é„‰', 'é«˜æ¨¹é„‰', 'é¹½åŸ”é„‰', 'å…§åŸ”é„‰', 'ç«¹ç”°é„‰', 'è¬å·’é„‰', 'æ–°åŸ¤é„‰', 'æ‹å¯®é„‰', 'æ–°åœ’é„‰', 'å´é ‚é„‰', 'æ—é‚Šé„‰', 'å—å·é„‰', 'ä½³å†¬é„‰', 'ç‰çƒé„‰', 'è»ŠåŸé„‰', 'æ»¿å·é„‰', 'æ‹å±±é„‰', 'ä¸‰åœ°é–€é„‰', 'éœ§è‡ºé„‰', 'ç‘ªå®¶é„‰', 'æ³°æ­¦é„‰', 'ä¾†ç¾©é„‰', 'æ˜¥æ—¥é„‰', 'ç…å­é„‰', 'ç‰¡ä¸¹é„‰'],
            yilan: ['å®œè˜­å¸‚', 'ç¾…æ±é®', 'è˜‡æ¾³é®', 'é ­åŸé®', 'ç¤æºªé„‰', 'å£¯åœé„‰', 'å“¡å±±é„‰', 'å†¬å±±é„‰', 'äº”çµé„‰', 'ä¸‰æ˜Ÿé„‰', 'å¤§åŒé„‰', 'å—æ¾³é„‰'],
            hualien: ['èŠ±è“®å¸‚', 'é³³æ—é®', 'ç‰é‡Œé®', 'æ–°åŸé„‰', 'å‰å®‰é„‰', 'å£½è±é„‰', 'å…‰å¾©é„‰', 'è±æ¿±é„‰', 'ç‘ç©—é„‰', 'å¯Œé‡Œé„‰', 'ç§€æ—é„‰', 'è¬æ¦®é„‰', 'å“æºªé„‰'],
            taitung: ['è‡ºæ±å¸‚', 'æˆåŠŸé®', 'é—œå±±é®', 'å‘å—é„‰', 'å¤§æ­¦é„‰', 'å¤ªéº»é‡Œé„‰', 'æ±æ²³é„‰', 'é•·æ¿±é„‰', 'é¹¿é‡é„‰', 'æ± ä¸Šé„‰', 'ç¶ å³¶é„‰', 'å»¶å¹³é„‰', 'æµ·ç«¯é„‰', 'é”ä»é„‰', 'é‡‘å³°é„‰', 'è˜­å¶¼é„‰'],
            penghu: ['é¦¬å…¬å¸‚', 'æ¹–è¥¿é„‰', 'ç™½æ²™é„‰', 'è¥¿å¶¼é„‰', 'æœ›å®‰é„‰', 'ä¸ƒç¾é„‰'],
            kinmen: ['é‡‘åŸé®', 'é‡‘æ¹–é®', 'é‡‘æ²™é®', 'é‡‘å¯§é„‰', 'çƒˆå¶¼é„‰', 'çƒåµé„‰'],
            lienchiang: ['å—ç«¿é„‰', 'åŒ—ç«¿é„‰', 'è’å…‰é„‰', 'æ±å¼•é„‰']
        };
        
        // ç¶å®šåŸå¸‚é¸æ“‡å™¨çš„è®Šæ›´äº‹ä»¶
        function initCityDistrictSelector() {
            const citySelect = document.getElementById('citySelect');
            const districtSelect = document.getElementById('districtSelect');
            
            citySelect.addEventListener('change', function() {
                const selectedCity = this.value;
                console.log('é¸æ“‡çš„åŸå¸‚:', selectedCity); // é™¤éŒ¯ç”¨
                
                if (selectedCity && districts[selectedCity]) {
                    districtSelect.disabled = false;
                    districtSelect.innerHTML = '<option value="">è«‹é¸æ“‡å€åŸŸ</option>';
                    
                    districts[selectedCity].forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d;
                        opt.textContent = d;
                        districtSelect.appendChild(opt);
                    });
                    
                    console.log(`âœ“ å·²è¼‰å…¥ ${districts[selectedCity].length} å€‹è¡Œæ”¿å€`); // é™¤éŒ¯ç”¨
                } else {
                    districtSelect.disabled = true;
                    districtSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡åŸå¸‚</option>';
                }
            });
        }

        function renderRestaurantCards(data) {
            const listDiv = document.getElementById('restaurantListDiv');
            const countSpan = document.getElementById('restaurantCount');
            listDiv.innerHTML = '';
            countSpan.textContent = data.length;

            if (data.length === 0) {
                listDiv.innerHTML = '<div class="p-5 text-center text-muted">ç›®å‰æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„é¤å»³è³‡æ–™</div>';
                return;
            }

            data.forEach((res, index) => {
                const analysis = res.safety_analysis || {};
                const level = analysis.level || "ç„¡è³‡æ–™";
                
                // æ ¹æ“šå®Œæ•´é¢¨éšªç­‰ç´šåˆ¤å®šæ¨£å¼èˆ‡åœ–ç¤º
                let badgeClass = "badge-normal";
                let icon = "fa-info-circle";
                
                switch(level) {
                    case "å®˜æ–¹èªè­‰å„ª":
                        badgeClass = "badge-certified";
                        icon = "fa-certificate";  // ğŸ† èªè­‰å¾½ç« 
                        break;
                    case "å®‰å…¨":
                        badgeClass = "badge-safe";
                        icon = "fa-circle-check";  // âœ… å®‰å…¨ç¢ºèª
                        break;
                    case "ä½é¢¨éšª":
                        badgeClass = "badge-low-risk";
                        icon = "fa-triangle-exclamation";  // âš ï¸ è­¦å‘Šï¼ˆé»ƒè‰²ï¼‰
                        break;
                    case "ä¸­é¢¨éšª":
                        badgeClass = "badge-medium-risk";
                        icon = "fa-triangle-exclamation";  // âš ï¸ è­¦å‘Š
                        break;
                    case "é«˜é¢¨éšª":
                        badgeClass = "badge-high-risk";
                        icon = "fa-circle-xmark";  // âŒ å±éšª
                        break;
                    case "ç¨½æ ¸æœªé€šé":
                        badgeClass = "badge-inspection-failed";
                        icon = "fa-ban";  // ğŸš« ç¦æ­¢/ä¸åˆæ ¼
                        break;
                    case "ç„¡/ä½é¢¨éšª":  // å‘ä¸‹ç›¸å®¹èˆŠè³‡æ–™
                        badgeClass = "badge-safe";
                        icon = "fa-circle-check";
                        break;
                    default:
                        // ä¿ç•™èˆŠé‚è¼¯ä½œç‚ºå‚™ç”¨
                        if(level.includes("å„ª")) { badgeClass = "badge-certified"; icon = "fa-certificate"; }
                        else if(level.includes("å®‰å…¨")) { badgeClass = "badge-safe"; icon = "fa-circle-check"; }
                        else if(level.includes("ä½")) { badgeClass = "badge-low-risk"; icon = "fa-triangle-exclamation"; }
                        else if(level.includes("ä¸­")) { badgeClass = "badge-medium-risk"; icon = "fa-triangle-exclamation"; }
                        else if(level.includes("é«˜")) { badgeClass = "badge-high-risk"; icon = "fa-circle-xmark"; }
                        else if(level.includes("ç¨½æ ¸") || level.includes("æœªé€šé")) { badgeClass = "badge-inspection-failed"; icon = "fa-ban"; }
                }

                const addrId = `res-addr-${index}`;
                const cardId = `res-card-${index}`;
                
                const cardHtml = `
                    <div class="restaurant-card" id="${cardId}" data-index="${index}" onclick="highlightRestaurant(${index})">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <h6 class="card-title mb-0">${res.name}</h6>
                            <span class="star-rating">
                                <i class="fas fa-star"></i>
                                <span class="text-dark ms-1 fw-bold">${res.rating || '--'}</span>
                            </span>
                        </div>
                        
                        <div class="address-text" id="${addrId}">
                            <i class="fas fa-location-dot opacity-50"></i> 
                            <span>${res.formatted_address || 'æ­£åœ¨æœå°‹è©³ç´°ä½ç½®...'}</span>
                        </div>
                        
                        <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
                            <span class="food-safety-badge ${badgeClass}">
                                <i class="fas ${icon}"></i> é£Ÿå®‰è©•ç´šï¼š${level}
                            </span>
                            ${analysis.official_certification ? 
                                `<span class="food-safety-badge badge-official">
                                    <i class="fas fa-award"></i> å®˜æ–¹èªè­‰ï¼š${analysis.official_certification.rating}
                                </span>` : ''
                            }
                        </div>

                        <div class="analysis-info">
                            <i class="far fa-comment-dots"></i> å–æ¨£åˆ†æ ${analysis.total_reviews_analyzed || 0} å‰‡è¿‘æœŸè©•è«–
                        </div>
                        
                        <div class="mt-2">
                            ${ (analysis.matched_keywords || []).map(kw => {
                                const isRisk = ['è…¹ç€‰','ä¸ä¹¾æ·¨','èŸ‘è‚','ä¸­æ¯’','ä¸è¡›','ç•°å‘³','æ‹‰è‚šå­','èšŠè …','æ­»æ‰','è‡­å‘³'].some(r=>kw.includes(r));
                                return `<span class="keyword-tag ${isRisk ? 'risk' : ''}">${kw}</span>`;
                            }).join('') }
                        </div>
                    </div>
                `;
                listDiv.insertAdjacentHTML('beforeend', cardHtml);

                if (!res.address || res.address === 'æ­£åœ¨æœå°‹è©³ç´°ä½ç½®...') {
                    fetchAddressFromGoogle(res.name, addrId);
                }
            });
        }

        function fetchAddressFromGoogle(restaurantName, elementId) {
            if (!window.google || !window.google.maps || !window.google.maps.places) return;
            const service = new google.maps.places.PlacesService(document.createElement('div'));
            const request = { query: restaurantName, fields: ['formatted_address'] };
            service.findPlaceFromQuery(request, (results, status) => {
                const addrElement = document.getElementById(elementId);
                if (!addrElement) return;
                if (status === google.maps.places.PlacesServiceStatus.OK && results[0]) {
                    addrElement.querySelector('span').textContent = results[0].formatted_address;
                } else {
                    addrElement.querySelector('span').textContent = 'æœªæä¾›åœ°å€è³‡æ–™';
                }
            });
        }

        // ç§»é™¤ï¼šä¸å†éœ€è¦é å…ˆè¼‰å…¥éœæ…‹ JSON
        // let allRestaurants = [];
        // async function loadData() {
        //     try {
        //         const response = await fetch('./safety_classified.json');
        //         allRestaurants = await response.json();
        //         renderRestaurantCards(allRestaurants);
        //     } catch (err) {
        //         console.error("æ•¸æ“šåŠ è¼‰å¤±æ•—", err);
        //     }
        // }

        // ä¿®æ”¹ï¼šæ”¹ç”¨ API æœå°‹
        document.getElementById('searchBtn').addEventListener('click', async function() {
            // å–å¾—è¼¸å…¥å€¼
            const citySelect = document.getElementById('citySelect');
            const district = document.getElementById('districtSelect').value;
            const address = document.getElementById('addressInput').value;
            
            // å–å¾—åŸå¸‚ä¸­æ–‡åç¨±
            const cityText = citySelect.options[citySelect.selectedIndex].text;
            
            // é©—è­‰è¼¸å…¥
            if (!citySelect.value || !address) {
                alert('è«‹é¸æ“‡åŸå¸‚ä¸¦è¼¸å…¥åœ°å€');
                return;
            }
            
            // é¡¯ç¤º Loading ç‹€æ…‹
            const originalText = this.innerHTML;
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span style="font-size: 0.9rem;">æœå°‹ä¸­</span>';
            
            try {
                // ç™¼é€ API è«‹æ±‚
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        city: cityText,
                        district: district,
                        address: address
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    // é¡¯ç¤ºçµæœ
                    renderRestaurantCards(data.restaurants);
                    document.getElementById('restaurantCount').textContent = data.count;
                    
                    // åœ¨åœ°åœ–ä¸Šæ¨™è¨˜é¤å»³ä½ç½®
                    addRestaurantMarkers(data.restaurants);
                    
                    // æ¨™è¨˜æœå°‹ä¸­å¿ƒé»ï¼ˆä½¿ç”¨ç¬¬ä¸€å€‹é¤å»³çš„ä½ç½®ä½œç‚ºåƒè€ƒï¼‰
                    if (data.restaurants.length > 0 && data.restaurants[0].lat && data.restaurants[0].lng) {
                        addSearchCenterMarker(data.restaurants[0].lat, data.restaurants[0].lng, `${cityText}${district}${address}`);
                    }
                    
                    console.log(`âœ“ æ‰¾åˆ° ${data.count} é–“é¤å»³`);
                } else {
                    alert('æœå°‹å¤±æ•—ï¼š' + data.message);
                }
                
            } catch (error) {
                console.error('æœå°‹éŒ¯èª¤:', error);
                alert('æœå°‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦');
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                this.disabled = false;
                this.innerHTML = originalText;
            }
        });

        let map;
        let markers = []; // å„²å­˜æ‰€æœ‰æ¨™è¨˜
        let infoWindows = []; // å„²å­˜æ‰€æœ‰è³‡è¨Šè¦–çª—
        let currentRestaurants = []; // å„²å­˜ç›®å‰çš„é¤å»³è³‡æ–™
        let CustomMarker; // å®£å‘Š CustomMarker é¡åˆ¥
        
        function initMap() {
          map = new google.maps.Map(document.getElementById("mapDiv"), {
            center: { lat: 25.034, lng: 121.564 },
            zoom: 13,
            styles: [
                { "featureType": "all", "elementType": "labels.text.fill", "stylers": [{ "color": "#617073" }] },
                { "featureType": "landscape", "elementType": "all", "stylers": [{ "color": "#F2F2F2" }] },
                { "featureType": "water", "elementType": "all", "stylers": [{ "color": "#CAD2C5" }, { "visibility": "on" }] },
                // éš±è—é è¨­çš„ POI åœ–ç¤º
                { "featureType": "poi", "elementType": "labels.icon", "stylers": [{ "visibility": "off" }] }
            ],
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: true
          });
          
          // åœ¨ Google Maps API è¼‰å…¥å¾Œå®šç¾© CustomMarker é¡åˆ¥
          CustomMarker = class extends google.maps.OverlayView {
            constructor(position, map, type, number) {
                super();
                this.position = position;
                this.type = type;
                this.number = number;
                
                // è¨­å®šæ¨£å¼
                if (type === 'restaurant') {
                    this.backgroundColor = '#7ec055';
                    this.iconClass = 'fa-utensils';
                } else {
                    this.backgroundColor = '#DC2626';
                    this.iconClass = 'fa-location-dot';
                }
                
                this.setMap(map);
            }
            
            onAdd() {
                // å‰µå»ºæ¨™è¨˜å®¹å™¨
                this.div = document.createElement('div');
                this.div.style.position = 'absolute';
                this.div.style.cursor = 'pointer';
                
                // å‰µå»ºåœ“å½¢èƒŒæ™¯
                const circle = document.createElement('div');
                circle.style.width = '40px';
                circle.style.height = '40px';
                circle.style.borderRadius = '50%';
                circle.style.backgroundColor = this.backgroundColor;
                circle.style.border = '2px solid #FFFFFF';
                circle.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
                circle.style.display = 'flex';
                circle.style.alignItems = 'center';
                circle.style.justifyContent = 'center';
                circle.style.position = 'relative';
                
                // å‰µå»º FontAwesome åœ–ç¤º
                const icon = document.createElement('i');
                icon.className = `fas ${this.iconClass}`;
                icon.style.color = '#FFFFFF';
                icon.style.fontSize = '18px';
                
                circle.appendChild(icon);
                
                // å¦‚æœæœ‰ç·¨è™Ÿï¼Œæ·»åŠ ç·¨è™Ÿæ¨™ç±¤
                if (this.number) {
                    const badge = document.createElement('div');
                    badge.style.position = 'absolute';
                    badge.style.top = '-2px';
                    badge.style.right = '-2px';
                    badge.style.width = '18px';
                    badge.style.height = '18px';
                    badge.style.borderRadius = '50%';
                    badge.style.backgroundColor = '#DC2626';
                    badge.style.border = '2px solid #FFFFFF';
                    badge.style.display = 'flex';
                    badge.style.alignItems = 'center';
                    badge.style.justifyContent = 'center';
                    badge.style.fontSize = '10px';
                    badge.style.fontWeight = 'bold';
                    badge.style.color = '#FFFFFF';
                    badge.textContent = this.number;
                    
                    circle.appendChild(badge);
                }
                
                this.div.appendChild(circle);
                
                // æ·»åŠ é»æ“Šäº‹ä»¶
                this.div.addEventListener('click', () => {
                    google.maps.event.trigger(this, 'click');
                });
                
                const panes = this.getPanes();
                panes.overlayMouseTarget.appendChild(this.div);
            }
            
            draw() {
                const overlayProjection = this.getProjection();
                const pos = overlayProjection.fromLatLngToDivPixel(this.position);
                
                if (this.div) {
                    this.div.style.left = (pos.x - 20) + 'px';
                    this.div.style.top = (pos.y - 20) + 'px';
                }
            }
            
            onRemove() {
                if (this.div) {
                    this.div.parentNode.removeChild(this.div);
                    this.div = null;
                }
            }
            
            getPosition() {
                return this.position;
            }
          };
        }
        
        // æ¸…é™¤æ‰€æœ‰åœ°åœ–æ¨™è¨˜
        function clearMarkers() {
            markers.forEach(marker => {
                if (marker.setMap) {
                    marker.setMap(null);
                }
            });
            markers = [];
            infoWindows = [];
        }
        
        // æ·»åŠ æœå°‹ä¸­å¿ƒé»æ¨™è¨˜ï¼ˆç´…è‰²å®šä½åœ–ç¤ºï¼‰
        let searchCenterMarker = null;
        function addSearchCenterMarker(lat, lng, searchQuery) {
            // ç§»é™¤èˆŠçš„ä¸­å¿ƒé»æ¨™è¨˜
            if (searchCenterMarker) {
                searchCenterMarker.setMap(null);
            }
            
            const position = { lat: lat, lng: lng };
            
            // å‰µå»ºç´…è‰²å®šä½æ¨™è¨˜ - ä½¿ç”¨è‡ªå®šç¾© HTML æ¨™è¨˜
            searchCenterMarker = new CustomMarker(position, map, 'location', null);
            
            // æ·»åŠ è³‡è¨Šè¦–çª—
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div style="padding: 10px; min-width: 160px;">
                        <h6 style="margin: 0 0 6px 0; color: #DC2626; font-weight: 700; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-location-crosshairs" style="font-size: 16px;"></i>
                            <span>æœå°‹ä½ç½®</span>
                        </h6>
                        <div style="font-size: 12px; color: #667771; font-weight: 600; margin-top: 4px;">
                            ${searchQuery}
                        </div>
                    </div>
                `
            });
            
            searchCenterMarker.addListener('click', () => {
                infoWindow.open(map, searchCenterMarker);
            });
        }
        
        // é«˜äº®é¡¯ç¤ºæŒ‡å®šçš„é¤å»³ï¼ˆåœ°åœ–æ¨™è¨˜èˆ‡åˆ—è¡¨å¡ç‰‡åŒæ­¥ï¼‰
        function highlightRestaurant(index) {
            // ç§»é™¤æ‰€æœ‰å¡ç‰‡çš„é«˜äº®ç‹€æ…‹
            document.querySelectorAll('.restaurant-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // é«˜äº®ç•¶å‰å¡ç‰‡
            const currentCard = document.getElementById(`res-card-${index}`);
            if (currentCard) {
                currentCard.classList.add('active');
                // æ»¾å‹•åˆ°è©²å¡ç‰‡
                currentCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            // é—œé–‰æ‰€æœ‰è³‡è¨Šè¦–çª—
            infoWindows.forEach(iw => iw.close());
            
            // æ‰“é–‹å°æ‡‰çš„æ¨™è¨˜è³‡è¨Šè¦–çª—
            if (infoWindows[index] && markers[index]) {
                infoWindows[index].open(map, markers[index]);
                
                // å°‡åœ°åœ–ä¸­å¿ƒç§»åˆ°è©²æ¨™è¨˜
                map.panTo(markers[index].getPosition());
            }
        }
        
        // åœ¨åœ°åœ–ä¸Šæ¨™è¨˜é¤å»³ä½ç½®
        function addRestaurantMarkers(restaurants) {
            if (!map || restaurants.length === 0) return;
            
            clearMarkers(); // å…ˆæ¸…é™¤èˆŠæ¨™è¨˜
            currentRestaurants = restaurants; // å„²å­˜é¤å»³è³‡æ–™
            
            const bounds = new google.maps.LatLngBounds(); // ç”¨ä¾†è‡ªå‹•èª¿æ•´åœ°åœ–ç¯„åœ
            
            restaurants.forEach((restaurant, index) => {
                if (!restaurant.lat || !restaurant.lng) return; // æ²’æœ‰ç¶“ç·¯åº¦å°±è·³é
                
                const position = { lat: restaurant.lat, lng: restaurant.lng };
                
                // å‰µå»ºæ¨™è¨˜ - ä½¿ç”¨è‡ªå®šç¾© HTML æ¨™è¨˜èˆ‡ FontAwesome åœ–ç¤º
                const marker = new CustomMarker(position, map, 'restaurant', index + 1);
                
                // é»æ“Šæ¨™è¨˜æ™‚é¡¯ç¤ºè³‡è¨Šè¦–çª—èˆ‡åº—å®¶åç¨±
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px 12px; min-width: 200px;">
                            <h6 style="margin: 0 0 8px 0; color: #354F52; font-weight: 700; font-size: 15px;">
                                ${restaurant.name}
                            </h6>
                            <div style="color: #E9C46A; font-size: 14px; margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-star" style="font-size: 14px;"></i>
                                <span style="font-weight: 600; color: #354F52;">${restaurant.rating || '--'}</span>
                            </div>
                            <div style="font-size: 12px; color: #667771; margin-top: 6px; display: flex; align-items: flex-start; gap: 6px; line-height: 1.4;">
                                <i class="fas fa-location-dot" style="margin-top: 2px; flex-shrink: 0; font-size: 13px;"></i>
                                <span>${restaurant.formatted_address || restaurant.address || ''}</span>
                            </div>
                            ${restaurant.safety_analysis ? `
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee;">
                                <span style="font-size: 11px; color: #84A98C; display: flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-shield-halved" style="font-size: 13px;"></i>
                                    <span style="font-weight: 600;">${restaurant.safety_analysis.level}</span>
                                </span>
                            </div>
                            ` : ''}
                        </div>
                    `
                });
                
                // é»æ“Šæ¨™è¨˜æ™‚ï¼šé¡¯ç¤ºåº—å®¶è³‡è¨Šèˆ‡è³‡è¨Šè¦–çª—
                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                    highlightRestaurant(index);
                });
                
                markers.push(marker);
                infoWindows.push(infoWindow);
                bounds.extend(position); // æ“´å±•é‚Šç•Œä»¥åŒ…å«æ­¤æ¨™è¨˜
            });
            
            // è‡ªå‹•èª¿æ•´åœ°åœ–ä»¥é¡¯ç¤ºæ‰€æœ‰æ¨™è¨˜
            if (restaurants.length === 1) {
                map.setCenter(bounds.getCenter());
                map.setZoom(15);
            } else if (restaurants.length > 1) {
                map.fitBounds(bounds);
            }
        }

        // å¾å¾Œç«¯ç²å–é…ç½®ï¼ˆåŒ…å« Google Maps API Keyï¼‰
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                return config.googleMapsApiKey;
            } catch (error) {
                console.error('ç„¡æ³•è¼‰å…¥é…ç½®:', error);
                return null;
            }
        }

        // åˆå§‹åŒ– Google Maps
        async function initGoogleMaps() {
            const apiKey = await loadConfig();
            
            if (apiKey) {
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap&libraries=places&v=weekly&language=zh-TW`;
                script.async = true;
                script.defer = true;
                document.body.appendChild(script);
                console.log('âœ“ Google Maps API å·²è¼‰å…¥');
            } else {
                console.error('âŒ ç„¡æ³•å–å¾— Google Maps API Key');
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.onload = function() {
            initCityDistrictSelector(); // åˆå§‹åŒ–åŸå¸‚/è¡Œæ”¿å€é¸æ“‡å™¨
            initGoogleMaps();            // åˆå§‹åŒ– Google Maps
        };
    </script>
</body>
</html>