# 任務 03: 食安風險分析引擎

## 任務概述

開發評論關鍵字分析系統，整合官方餐飲評核與稽查資料，建立食安風險分級機制。

## 負責人

**Vickie**

## 任務狀態

- [x] 關鍵字庫建立
- [x] 評論分析邏輯
- [x] 官方評核資料整合
- [x] 稽查不合格資料整合
- [x] 模糊名稱比對演算法
- [x] 風險等級判定
- [x] 結果排序機制

## 相關檔案

- **主程式**: `food_safety_classifier.py`
- **輸入資料**:
  - `data/raw/places_with_reviews.json`
  - `data/external/certified_restaurants.csv`
  - `scraper/food_business_data.json`
- **輸出結果**: `data/processed/safety_classified.json`

## 風險等級定義

```python
class SafetyLevel(Enum):
    HIGH_RISK = "高風險"           # 評論提及負面症狀
    MEDIUM_RISK = "中風險"         # 評論提及生食料理
    LOW_RISK = "無/低風險"         # 無風險關鍵字
    CERTIFIED = "官方認證優"       # 台北市政府評核「優」等級
    INSPECTION = "稽核未通過"      # 政府稽查不合格
```

### 顯示邏輯（前端）

當風險等級為「無/低風險」時，根據是否有關鍵字提及進行細分顯示：

- **安全**：無任何症狀或生食關鍵字提及（`symptom_mentions = 0` 且 `raw_food_mentions = 0`）
  - 配色：天藍色 #E0F2FE
  - 圖示：✓ 圓圈勾勾
- **低風險**：有關鍵字提及但不屬於高/中風險
  - 配色：琥珀黃 #FEF3C7
  - 圖示：⚠️ 三角警告

```javascript
// 前端顯示邏輯
const displayLevel =
  level === '無/低風險' &&
  analysis.symptom_mentions === 0 &&
  analysis.raw_food_mentions === 0
    ? '安全'
    : level === '無/低風險'
    ? '低風險'
    : level
```

## 關鍵字庫設計

### 1. 症狀關鍵字 (SYMPTOM_KEYWORDS) - 共 47 個

**類別 1: 急性病徵**

```python
# 全身症狀
["發燒", "虛弱", "頭暈", "冒冷汗", "肌肉酸痛", "發冷"]

# 消化系統症狀
["嘔吐", "噁心", "胃痙攣", "上吐下瀉",
 "拉肚子", "腹瀉", "肚子痛", "狂拉", "狂瀉", "跑廁所", "腹絞痛"]

# 其他症狀與就醫紀錄
["紅疹", "過敏", "看醫生", "掛急診", "腸胃炎", "食物中毒"]
```

**類別 2: 感官異狀**

```python
# 嗅覺/味覺異常
["不新鮮", "臭掉", "壞掉", "發霉", "有異味", "臭酸味", "酸臭",
 "藥水味", "漂白水味", "土味", "油耗味", "腐敗"]
```

**類別 3: 物理性危害**

```python
# 未熟與異物
["沒熟", "沒煮熟", "血水",
 "吃到頭髮", "吃到蟑螂", "有蟲", "碎玻璃", "鋼刷絲", "異物", "塑膠片"]
```

**類別 4: 環境問題**

```python
["衛生問題", "環境髒亂"]
```

### 2. 高風險料理關鍵字 (DISH_KEYWORDS) - 共 17 個

**生食與半熟料理**

```python
["生魚片", "刺身", "握壽司",              # 日式生食
 "韃靼牛肉", "生牛肉",                     # 西式生食
 "生蠔", "生醃", "醬蟹",                   # 海鮮生醃
 "生雞蛋", "蛋液", "半熟蛋", "太陽蛋",     # 蛋類
 "法式吐司",                               # 可能含生蛋
 "生菜沙拉", "越式春捲",                   # 生菜
 "提拉米蘇", "美乃滋"]                     # 含生蛋製品
```

## 核心功能

### 1. 官方資料載入

#### 餐飲衛生評核資料

**函數**: `load_certified_restaurants()`

**資料來源**: 台北市政府開放資料平台

**篩選邏輯**:

- 僅保留評核結果為「優」的餐廳
- 排除「良」等級
- 建立名稱索引字典

**回傳結構**:

```python
{
    "餐廳名稱": {
        "district_code": "63000010",
        "district_name": "松山區",
        "registration_id": "A123456789",
        "address": "完整地址",
        "certification_rating": "優"
    }
}
```

#### 稽查不合格資料

**函數**: `load_inspection_failed()`

**資料來源**: 政府食品稽查網站（爬蟲取得）

**回傳結構**:

```python
{
    "業者名稱": {
        "address": "違規地址",
        "registration_number": "登錄字號"
    }
}
```

### 2. 模糊名稱比對

**函數**: `fuzzy_match_certification()`

**比對策略**:

**策略 1: 完全名稱比對**

```python
if restaurant_name in certified_data:
    return certified_data[restaurant_name]
```

**策略 2: 清理後比對**

```python
# 移除常見後綴
suffixes = ["餐廳", "店", "門市", "分店", "旗艦店"]
clean_name = remove_suffixes(name)
```

**策略 3: 部分名稱 + 地址交叉驗證**

```python
if name_similar and same_district(address1, address2):
    return match
```

### 3. 評論風險分析

**函數**: `classify_review()`

**分析邏輯**:

1. 將評論文字轉為小寫
2. 掃描症狀關鍵字
3. 掃描生食關鍵字
4. 回傳匹配結果

**回傳結構**:

```python
{
    "has_symptoms": bool,
    "has_raw_food": bool,
    "matched_keywords": ["症狀:拉肚子", "生食:生魚片"]
}
```

### 4. 餐廳整體風險判定

**函數**: `classify_restaurant()`

**判定邏輯架構**:

```python
def classify_restaurant(restaurant, certified_data, inspection_failed_data):
    """
    完整風險評估流程：
    1. 檢查稽查不合格名單（模糊比對）
    2. 檢查官方認證資料（模糊比對）
    3. 分析所有評論內容
    4. 依據優先級判定風險等級
    """
```

**判定優先級（由高至低）**:

1. **症狀關鍵字 > 0** → 高風險 🔴
2. **稽查不合格名單** → 稽核未通過 ⛔
3. **官方認證優等級** → 官方認證優 🟢
4. **生食關鍵字 > 0** → 中風險 🟠
5. **無任何關鍵字** → 無/低風險 🔵/🟡
   - 前端顯示為「安全」（無關鍵字）或「低風險」（有關鍵字）

**優先級設計原理**:

- **症狀優先**: 實際用餐體驗問題最嚴重，無論是否有官方認證都標記為高風險
- **稽查次之**: 政府實地稽查發現問題，具有法律效力
- **認證再次**: 官方主動評核通過，但仍需注意評論內容
- **生食最後**: 僅為潛在風險提示，非實際問題
- **顯示細化**: 「無/低風險」根據關鍵字數量細分為「安全」或「低風險」，提供更精準的風險判斷

**回傳結構**:

```python
{
    ...原餐廳資料,
    "safety_analysis": {
        "level": "官方認證優",
        "symptom_mentions": 0,
        "raw_food_mentions": 2,
        "matched_keywords": ["生食:生魚片"],
        "total_reviews_analyzed": 5,
        "flagged_reviews": [...],
        "official_certification": {...},
        "inspection_status": null
    }
}
```

### 5. 主流程整合

**函數**: `process_all_restaurants()`

**執行步驟**:

1. 載入官方評核資料
2. 載入稽查不合格資料
3. 載入爬蟲資料
4. 執行風險分類
5. 排序（推薦順序：認證 > 低風險 > 中風險 > 高風險 > 稽查不合格）
6. 儲存結果並輸出摘要

## 使用方式

```bash
# 確保資料檔案存在
# 1. data/raw/places_with_reviews.json
# 2. data/external/certified_restaurants.csv
# 3. scraper/food_business_data.json

# 執行分析
python food_safety_classifier.py
```

## 輸出範例

```
==================================================
食品安全風險分級系統
==================================================

Step 1: 載入官方餐飲衛生評核資料...
  原始資料: 1500 筆
  評核「優」: 800 筆（已納入）
  評核「良」: 700 筆（已排除）

Step 1.5: 載入稽查不合格資料...
  稽食安評選完整流程

### 執行步驟詳解

```

Step 1: 載入官方餐飲衛生評核資料
└─ 讀取 data/external/certified_restaurants.csv
└─ 篩選評核結果為「優」的餐廳 (1,609 筆)
└─ 排除「良」等級
└─ 建立名稱索引字典

Step 1.5: 載入稽查不合格資料
└─ 讀取 data/external/food_business_data.json
└─ 建立業者名稱索引 (208 筆)

Step 2: 載入爬蟲資料
└─ 讀取 data/raw/places_with_reviews.json
└─ 支援兩種格式：直接陣列或包含 restaurants key

Step 3: 執行食安風險分類
└─ 對每家餐廳執行：
├─ 模糊比對稽查不合格名單
├─ 模糊比對官方認證資料
├─ 分析所有評論關鍵字
└─ 依優先級判定風險等級

Step 4: 排序輸出
└─ 第一排序：風險等級 (認證 > 低 > 中 > 高 > 稽查)
└─ 第二排序：Google 評分（高到低）

Ste 程式碼架構說明

### 模組組織

```python
api/classifier.py (535 lines)
├── 常數定義 (Lines 1-97)
│   ├── SafetyLevel (Enum)
│   ├── SYMPTOM_KEYWORDS (47 個)
│   ├── DISH_KEYWORDS (17 個)
│   └── DISTRICT_MAP (12 區)
│
├── 官方資料載入 (Lines 98-163)
│   ├── load_certified_restaurants()
│   └── load_inspection_failed()
│
├── 模糊比對 (Lines 164-242)
│   └── fuzzy_match_certification()
│       ├── 策略 1: 完全名稱比對
│       ├── 策略 2: 清理後比對
│       └── 策略 3: 部分名稱 + 地址驗證
│
├── 評論分析 (Lines 243-323)
│   ├── classify_review()      # 單則評論
│   └── classify_restaurant()  # 整家餐廳
│
└── 主流程 (Lines 324-535)
    └── process_all_restaurants()
        ├── 載入三種資料來源
        ├── 執行分類
        ├── 排序結果
        └── 輸出摘要
```

### 關鍵函數介面

```python
# 1. 評論級別分析
def classify_review(review_text: str) -> Dict[str, Any]:
    """
    輸入: 單則評論文字
    輸出: {
        "has_symptoms": bool,
        "has_raw_food": bool,
        "matched_keywords": List[str]
    }
    """

# 2. 餐廳級別分析
def classify_restaurant(
    restaurant: Dict[str, Any],
    certified_data: Dict[str, Dict[str, str]],
    inspection_failed_data: Dict[str, Dict[str, str]]
) -> Dict[str, Any]:
    """
    輸入: 餐廳資料 + 兩份官方資料
    輸出: 原餐廳資料 + safety_analysis 欄位
    """

# 3. 模糊比對
def fuzzy_match_certification(
    restaurant_name: str,
    restaurant_address: str,
    certified_data: Dict[str, Dict[str, str]]
) -> Optional[Dict[str, str]]:
    """
    輸入: 餐廳名稱、地址、官方資料庫
    輸出: 匹配的認證資訊或 None
    策略: 三段式比對（完全 → 清理 → 部分+地址）
    """
```

### 資料結構定義

**輸出的 safety_analysis 完整結構**:

```json
{
  "level": "官方認證優",
  "symptom_mentions": 0,
  "raw_food_mentions": 1,
  "matched_keywords": ["生食:半熟蛋"],
  "total_reviews_analyzed": 5,
  "flagged_reviews": null,
  "official_certification": {
    "status": "通過評核",
    "rating": "優",
    "registration_id": "A-166432303-00058-8",
    "certified_address": "臺北市內湖區民善街88號",
    "district": "內湖區"
  },
  "inspection_status": null
}
```

## 測試檢查

- [x] 關鍵字匹配正確
- [x] 模糊比對運作正常
- [x] 官方資料整合成功
- [x] 風險等級判定正確
- [x] 排序邏輯驗證
- [x] 輸出格式符合前端需求

## 已知限制

1. **地理範圍**: 目前官方資料僅涵蓋台北市
2. **語言支援**: 僅支援繁體中文關鍵字匹配
3. **比對精度**: 模糊比對可能有誤判（特別是連鎖店）
4. **即時性**: 需手動更新官方認證與稽查資料

```
Google Places API → places_with_reviews.json (原始評論)
                            ↓
                    classify_review() ← SYMPTOM_KEYWORDS
                            ↓              DISH_KEYWORDS
                    逐則評論分析
                            ↓
                    classify_restaurant()
                            ↓
        ┌───────────────────┼───────────────────┐
        ↓                   ↓                   ↓
  稽查不合格?          官方認證?          關鍵字分析
  (優先級2)          (優先級3)          (優先級1/4)
        ↓                   ↓                   ↓
        └───────────────────┴───────────────────┘
                            ↓
                  safety_analysis 欄位
                            ↓
                  safety_classified.json
                            ↓
                    前端地圖顯示
```

## 待改進項目

### 功能擴充

- [ ] 關鍵字庫外部化（使用 YAML 配置）
- [ ] NLP 模型整合（情感分析）
- [ ] 風險分數計算（0-100 評分）
- [ ] 手動對應表（處理特殊名稱）

### 資料擴充

- [ ] 擴充至其他縣市官方認證資料
  - 新北市、桃園市、台中市、台南市、高雄市
  - 統一資料格式與欄位名稱
  - 更新 DISTRICT_MAP 支援全台行政區

### 品質改進

- [ ] 資料格式驗證
- [ ] 單元測試建立
- [ ] # 錯誤處理增強
  # 分類結果摘要
  ✅ 官方認證優: 2 家
  🟢 無/低風險: 2 家
  🟡 中風險: 1 家
  🔴 高風險: 0 家
  ⛔ 稽核未通過: 0 家

完整結果已儲存至: data/processed/safety_classified.json

````

## 待改進項目

- [ ] 關鍵字庫外部化（使用 YAML 配置）
- [ ] NLP 模型整合（情感分析）
- [ ] 風險分數計算（0-100 評分）
- [ ] 手動對應表（處理特殊名稱）
- [ ] 資料格式驗證
- [ ] 單元測試建立

## 前端視覺設計

### 配色方案

**食安評級配色**（區別於官方認證綠色）:

| 風險等級 | 配色 | 色碼 | 圖示 | 說明 |
|---------|------|------|------|------|
| 安全 | 🔵 天藍色 | `#E0F2FE` / `#075985` | `fa-circle-check` | 無任何風險關鍵字 |
| 低風險 | 🟡 琥珀黃 | `#FEF3C7` / `#92400E` | `fa-triangle-exclamation` | 有關鍵字但非高/中風險 |
| 中風險 | 🟠 橘色 | `#FED7AA` / `#9A3412` | `fa-triangle-exclamation` | 有生食關鍵字 |
| 高風險 | 🔴 紅色 | `#FECACA` / `#991B1B` | `fa-circle-xmark` | 有症狀關鍵字 |
| 官方認證優 | 🟢 綠色 | `#E8F3ED` / `#2D5016` | `fa-certificate` | 台北市政府認證 |
| 稽核未通過 | 🔴 深紅 | `#FEE2E2` / `#7F1D1D` | `fa-ban` | 政府稽查不合格 |

### CSS 樣式定義

```css
/* 食安評級樣式 - 與官方認證明顯區別 */
.badge-safe {
    background-color: #E0F2FE;
    color: #075985;
    border: 1px solid rgba(7, 89, 133, 0.2);
    font-weight: 600;
}

.badge-low-risk {
    background-color: #FEF3C7;
    color: #92400E;
    border: 1px solid rgba(146, 64, 14, 0.2);
    font-weight: 600;
}

.badge-medium-risk {
    background-color: #FED7AA;
    color: #9A3412;
    border: 1px solid rgba(154, 52, 18, 0.2);
    font-weight: 600;
}

.badge-high-risk {
    background-color: #FECACA;
    color: #991B1B;
    border: 1px solid rgba(153, 27, 27, 0.3);
    font-weight: 700;
}

/* 官方狀態徽章 */
.badge-certified {
    background-color: #E8F3ED;
    color: #2D5016;
    border: 1px solid rgba(45, 80, 22, 0.2);
    font-weight: 700;
}

.badge-inspection-failed {
    background-color: #FEE2E2;
    color: #7F1D1D;
    border: 2px solid #991B1B;
    font-weight: 700;
}
```

### 徽章顯示邏輯

**位置 1: 餐廳名稱旁的狀態徽章**

```html
<h6 class="card-title">餐廳名稱</h6>
<!-- 官方認證徽章 -->
<span class="status-badge status-badge-certified">
    <i class="fas fa-certificate"></i> 官方認證優
</span>
<!-- 稽核未通過徽章 -->
<span class="status-badge status-badge-inspection-failed">
    <i class="fas fa-exclamation-triangle"></i> 稽核未通過
</span>
```

**位置 2: 食安評級徽章**

```html
<span class="food-safety-badge badge-safe">
    <i class="fas fa-circle-check"></i> 食安評級：安全
</span>
```

### 顯示優先級

1. **官方認證優徽章** - 小型綠色徽章（餐廳名稱旁）
2. **稽核未通過徽章** - 小型紅色徽章（餐廳名稱旁）
3. **食安評級徽章** - 中型彩色徽章（地址下方）

這樣的設計確保：
- 官方狀態（認證/稽核）突出顯示在名稱旁
- 食安評級獨立顯示，顏色體系與官方認證有明顯區別
- 視覺層次清晰，使用者一眼就能識別餐廳的完整安全狀態

## 關鍵字維護指南

### 新增關鍵字

```python
# 1. 編輯 food_safety_classifier.py
# 2. 更新對應的關鍵字清單
SYMPTOM_KEYWORDS.extend([
    "新關鍵字1", "新關鍵字2"
])

# 3. 重新執行分析
python food_safety_classifier.py
````

### 分析誤判案例

1. 檢查 `flagged_reviews` 中的標記評論
2. 確認關鍵字是否合理
3. 調整關鍵字或新增排除規則

## 測試檢查

- [x] 關鍵字匹配正確
- [x] 模糊比對運作正常
- [x] 官方資料整合成功
- [x] 風險等級判定正確
- [x] 排序邏輯合理
- [x] 輸出格式正確

## 參考文件

- [專案規格 - 食安分析章節](../SPEC/project_spec.md#核心模組)
- [README - 評論分析說明](../README.md)
